<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AbbVie Irish Subsidiaries — Forensic Financial Analysis</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Sora:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg-primary: #06070b;
  --bg-secondary: #0c0d14;
  --bg-card: #11121b;
  --bg-card-hover: #181a26;
  --border: #1e2035;
  --border-accent: #2d3055;
  --text-primary: #e2e4f0;
  --text-secondary: #7c7fa8;
  --text-muted: #484a6a;
  --accent-red: #ff2d55;
  --accent-red-bg: rgba(255,45,85,0.08);
  --accent-amber: #ff9f0a;
  --accent-amber-bg: rgba(255,159,10,0.08);
  --accent-green: #30d158;
  --accent-green-bg: rgba(48,209,88,0.08);
  --accent-blue: #0a84ff;
  --accent-blue-bg: rgba(10,132,255,0.08);
  --accent-purple: #bf5af2;
  --accent-purple-bg: rgba(191,90,242,0.08);
  --accent-cyan: #64d2ff;
  --accent-cyan-bg: rgba(100,210,255,0.08);
  --accent-teal: #2dd4bf;
  --font-display: 'Playfair Display', serif;
  --font-body: 'Sora', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }

body {
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: var(--font-body);
  min-height: 100vh;
  overflow-x: hidden;
  line-height: 1.6;
}

/* Grain overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 10000;
}

/* Scanline */
@keyframes scanline {
  0% { transform: translateY(-100vh); }
  100% { transform: translateY(100vh); }
}
body::after {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
  opacity: 0.12;
  animation: scanline 6s linear infinite;
  pointer-events: none;
  z-index: 9999;
}

/* ═══ HEADER ═══ */
.header {
  padding: 40px 48px 32px;
  border-bottom: 1px solid var(--border);
  position: relative;
  overflow: hidden;
}
.header::before {
  content: '';
  position: absolute;
  top: -50%; left: -10%;
  width: 60%; height: 200%;
  background: radial-gradient(ellipse, rgba(255,45,85,0.06) 0%, transparent 70%);
  pointer-events: none;
}
.header::after {
  content: '';
  position: absolute;
  top: -50%; right: -10%;
  width: 40%; height: 200%;
  background: radial-gradient(ellipse, rgba(10,132,255,0.04) 0%, transparent 70%);
  pointer-events: none;
}
.header-inner { position: relative; display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 20px; }
.header-tag {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 2.5px;
  text-transform: uppercase;
  color: var(--accent-red);
  background: var(--accent-red-bg);
  border: 1px solid rgba(255,45,85,0.15);
  padding: 6px 14px;
  border-radius: 4px;
  margin-bottom: 14px;
}
.header-tag .dot {
  width: 6px; height: 6px;
  background: var(--accent-red);
  border-radius: 50%;
  animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

.header h1 {
  font-family: var(--font-display);
  font-size: clamp(28px, 4vw, 44px);
  font-weight: 700;
  letter-spacing: -0.5px;
  line-height: 1.15;
  color: var(--text-primary);
}
.header h1 em { font-style: italic; color: var(--accent-cyan); }
.header-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-top: 8px;
  font-weight: 300;
}
.header-right {
  text-align: right;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-muted);
  line-height: 1.8;
}
.header-right strong { color: var(--text-secondary); font-weight: 500; }

/* ═══ NAV TABS ═══ */
.nav-bar {
  display: flex;
  gap: 2px;
  padding: 0 48px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-secondary);
  overflow-x: auto;
}
.nav-tab {
  padding: 14px 22px;
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 400;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.3s;
  white-space: nowrap;
  background: none;
  border-top: none; border-left: none; border-right: none;
}
.nav-tab:hover { color: var(--text-secondary); background: rgba(255,255,255,0.02); }
.nav-tab.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); }

/* ═══ SECTIONS / PANELS ═══ */
.dashboard { padding: 32px 48px 60px; }
.section { display: none; }
.section.active { display: block; animation: fadeIn 0.4s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

.section-title {
  font-family: var(--font-display);
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 6px;
}
.section-desc {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 28px;
  font-weight: 300;
}

/* ═══ KPI STRIP ═══ */
.kpi-strip {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 32px;
}
.kpi-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 20px 22px;
  position: relative;
  overflow: hidden;
  transition: border-color 0.3s, transform 0.2s;
}
.kpi-card:hover { border-color: var(--border-accent); transform: translateY(-2px); }
.kpi-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 3px;
}
.kpi-card.red::before { background: linear-gradient(90deg, var(--accent-red), transparent); }
.kpi-card.blue::before { background: linear-gradient(90deg, var(--accent-blue), transparent); }
.kpi-card.green::before { background: linear-gradient(90deg, var(--accent-green), transparent); }
.kpi-card.amber::before { background: linear-gradient(90deg, var(--accent-amber), transparent); }
.kpi-card.purple::before { background: linear-gradient(90deg, var(--accent-purple), transparent); }
.kpi-card.cyan::before { background: linear-gradient(90deg, var(--accent-cyan), transparent); }

.kpi-label {
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 10px;
}
.kpi-value {
  font-family: var(--font-display);
  font-size: 28px;
  font-weight: 700;
  line-height: 1;
  margin-bottom: 4px;
}
.kpi-sub {
  font-size: 11px;
  color: var(--text-secondary);
  font-weight: 300;
}

/* ═══ GRID LAYOUTS ═══ */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 28px; }
.grid-full { margin-bottom: 28px; }

@media (max-width: 1100px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }

/* ═══ CHART CARDS ═══ */
.chart-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  position: relative;
  overflow: hidden;
}
.chart-card:hover { border-color: var(--border-accent); }
.chart-card h3 {
  font-family: var(--font-body);
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 4px;
}
.chart-card .chart-sub {
  font-size: 11px;
  color: var(--text-muted);
  margin-bottom: 18px;
  font-family: var(--font-mono);
}
.chart-wrapper { position: relative; width: 100%; }
.chart-wrapper canvas { width: 100% !important; }

/* ═══ DATA TABLE ═══ */
.data-table-wrapper {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
}
.table-header-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 18px 24px;
  border-bottom: 1px solid var(--border);
}
.table-header-bar h3 {
  font-size: 14px;
  font-weight: 600;
}
.table-search {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 7px 14px;
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 12px;
  outline: none;
  width: 240px;
  transition: border-color 0.3s;
}
.table-search:focus { border-color: var(--accent-cyan); }
.table-search::placeholder { color: var(--text-muted); }

.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}
.data-table thead th {
  padding: 12px 16px;
  text-align: left;
  font-family: var(--font-mono);
  font-size: 10px;
  letter-spacing: 1.2px;
  text-transform: uppercase;
  color: var(--text-muted);
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  white-space: nowrap;
  user-select: none;
  position: sticky;
  top: 0;
  background: var(--bg-card);
}
.data-table thead th:hover { color: var(--text-secondary); }
.data-table thead th .sort-arrow { margin-left: 4px; opacity: 0.4; }
.data-table thead th.sorted .sort-arrow { opacity: 1; color: var(--accent-cyan); }

.data-table tbody tr {
  border-bottom: 1px solid rgba(30,32,53,0.6);
  transition: background 0.2s;
}
.data-table tbody tr:hover { background: var(--bg-card-hover); }
.data-table tbody td {
  padding: 11px 16px;
  white-space: nowrap;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-secondary);
}
.data-table tbody td:first-child {
  font-family: var(--font-body);
  font-weight: 400;
  color: var(--text-primary);
  max-width: 320px;
  overflow: hidden;
  text-overflow: ellipsis;
}
.data-table tbody td.num { text-align: right; }
.data-table tbody td.positive { color: var(--accent-green); }
.data-table tbody td.negative { color: var(--accent-red); }
.data-table tbody td.na { color: var(--text-muted); font-style: italic; }

.data-table-scroll {
  max-height: 600px;
  overflow-y: auto;
}
.data-table-scroll::-webkit-scrollbar { width: 6px; }
.data-table-scroll::-webkit-scrollbar-track { background: var(--bg-card); }
.data-table-scroll::-webkit-scrollbar-thumb { background: var(--border-accent); border-radius: 3px; }

/* ═══ FLAGS / ALERTS ═══ */
.flag-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}
.flag-card {
  background: var(--bg-card);
  border-radius: 10px;
  padding: 20px 22px;
  position: relative;
  overflow: hidden;
  border: 1px solid;
}
.flag-card.critical { border-color: rgba(255,45,85,0.25); background: rgba(255,45,85,0.03); }
.flag-card.warning { border-color: rgba(255,159,10,0.25); background: rgba(255,159,10,0.03); }
.flag-card.info { border-color: rgba(10,132,255,0.25); background: rgba(10,132,255,0.03); }

.flag-badge {
  display: inline-block;
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  padding: 3px 10px;
  border-radius: 3px;
  margin-bottom: 10px;
  font-weight: 500;
}
.flag-card.critical .flag-badge { background: var(--accent-red-bg); color: var(--accent-red); }
.flag-card.warning .flag-badge { background: var(--accent-amber-bg); color: var(--accent-amber); }
.flag-card.info .flag-badge { background: var(--accent-blue-bg); color: var(--accent-blue); }

.flag-title { font-size: 14px; font-weight: 600; margin-bottom: 6px; }
.flag-desc { font-size: 12px; color: var(--text-secondary); line-height: 1.7; font-weight: 300; }
.flag-entity {
  margin-top: 10px;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
}

/* ═══ TREEMAP ═══ */
.treemap-container {
  display: flex;
  flex-wrap: wrap;
  gap: 3px;
  border-radius: 10px;
  overflow: hidden;
  min-height: 280px;
}
.treemap-item {
  border-radius: 6px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  min-height: 60px;
  cursor: pointer;
  transition: filter 0.2s, transform 0.15s;
  position: relative;
  overflow: hidden;
}
.treemap-item:hover { filter: brightness(1.2); transform: scale(1.02); z-index: 2; }
.treemap-item .tm-name {
  font-size: 11px;
  font-weight: 500;
  line-height: 1.3;
  word-break: break-word;
}
.treemap-item .tm-value {
  font-family: var(--font-mono);
  font-size: 13px;
  font-weight: 500;
  margin-top: 4px;
}

/* ═══ TOOLTIP ═══ */
.tooltip {
  position: fixed;
  background: #1a1b2e;
  border: 1px solid var(--border-accent);
  border-radius: 8px;
  padding: 14px 18px;
  font-size: 12px;
  color: var(--text-primary);
  pointer-events: none;
  z-index: 50000;
  display: none;
  max-width: 320px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.5);
  backdrop-filter: blur(10px);
}
.tooltip .tt-title { font-weight: 600; margin-bottom: 6px; font-size: 13px; }
.tooltip .tt-row {
  display: flex;
  justify-content: space-between;
  gap: 20px;
  padding: 2px 0;
  font-family: var(--font-mono);
  font-size: 11px;
}
.tooltip .tt-row .tt-label { color: var(--text-muted); }

/* ═══ STAT BARS ═══ */
.stat-bar-group { margin-bottom: 28px; }
.stat-bar-item { margin-bottom: 14px; }
.stat-bar-label {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  margin-bottom: 5px;
}
.stat-bar-label .sbl-name { font-weight: 400; }
.stat-bar-label .sbl-value { font-family: var(--font-mono); color: var(--text-secondary); font-size: 11px; }
.stat-bar-track {
  height: 6px;
  background: rgba(255,255,255,0.04);
  border-radius: 3px;
  overflow: hidden;
}
.stat-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 1s ease;
}

/* ═══ MISC ═══ */
.divider {
  border: none;
  border-top: 1px solid var(--border);
  margin: 32px 0;
}
.footnote {
  font-size: 11px;
  color: var(--text-muted);
  font-style: italic;
  margin-top: 20px;
  line-height: 1.7;
}

/* scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-accent); }
</style>
</head>
<body>

<!-- TOOLTIP -->
<div class="tooltip" id="tooltip"></div>

<!-- HEADER -->
<header class="header">
  <div class="header-inner">
    <div class="header-left">
      <div class="header-tag"><span class="dot"></span> Forensic Analysis</div>
      <h1>AbbVie <em>Irish Subsidiaries</em></h1>
      <p class="header-subtitle">Deep-dive into 31 entities registered in Ireland — Revenue, Profit, Tax, Assets & IP structure</p>
    </div>
    <div class="header-right">
      <div><strong>Entities Analyzed:</strong> 31</div>
      <div><strong>With Financial Data:</strong> 20</div>
    </div>
  </div>
</header>

<!-- NAV -->
<nav class="nav-bar">
  <button class="nav-tab active" data-tab="overview">Overview</button>
  <button class="nav-tab" data-tab="revenue">Revenue & Profit</button>
  <button class="nav-tab" data-tab="tax">Tax Analysis</button>
  <button class="nav-tab" data-tab="assets">Assets & IP</button>
  <button class="nav-tab" data-tab="flags">Red Flags</button>
  <button class="nav-tab" data-tab="entities">All Entities</button>
</nav>

<!-- DASHBOARD -->
<div class="dashboard">

  <!-- ═══════ OVERVIEW ═══════ -->
  <div class="section active" id="sec-overview">
    <h2 class="section-title">Executive Summary</h2>
    <p class="section-desc">Aggregate forensic metrics across AbbVie's Irish corporate structure</p>

    <div class="kpi-strip">
      <div class="kpi-card cyan">
        <div class="kpi-label">Total Revenue</div>
        <div class="kpi-value">€12.76B</div>
        <div class="kpi-sub">7 entities reporting</div>
      </div>
      <div class="kpi-card blue">
        <div class="kpi-label">Aggregate PBT</div>
        <div class="kpi-value">€8.53B</div>
        <div class="kpi-sub">18 entities reporting</div>
      </div>
      <div class="kpi-card red">
        <div class="kpi-label">Net Tax Paid</div>
        <div class="kpi-value">−€924K</div>
        <div class="kpi-sub">Net tax refund across 11 entities</div>
      </div>
      <div class="kpi-card amber">
        <div class="kpi-label">Total Assets</div>
        <div class="kpi-value">€135.2B</div>
        <div class="kpi-sub">20 entities reporting</div>
      </div>
      <div class="kpi-card purple">
        <div class="kpi-label">Intangibles</div>
        <div class="kpi-value">€20.6B</div>
        <div class="kpi-sub">15.2% of total assets</div>
      </div>
      <div class="kpi-card green">
        <div class="kpi-label">Total Employees</div>
        <div class="kpi-value">784</div>
        <div class="kpi-sub">Avg 131 per reporting entity (6)</div>
      </div>
    </div>

    <div class="chart-card grid-full">
      <h3>Revenue Concentration</h3>
      <div class="chart-sub">Top entities by reported revenue</div>
      <div class="chart-wrapper"><canvas id="chartRevenueConc"></canvas></div>
    </div>

    <div class="chart-card grid-full">
      <h3>Revenue per Employee — Productivity Forensic</h3>
      <div class="chart-sub">Only entities with both revenue and employee data</div>
      <div class="chart-wrapper"><canvas id="chartRevPerEmp"></canvas></div>
    </div>
  </div>

  <!-- ═══════ REVENUE & PROFIT ═══════ -->
  <div class="section" id="sec-revenue">
    <h2 class="section-title">Revenue & Profit Analysis</h2>
    <p class="section-desc">Breakdown of revenue streams and profit before tax across the Irish structure</p>

    <div class="kpi-strip">
      <div class="kpi-card cyan">
        <div class="kpi-label">Top Revenue Entity</div>
        <div class="kpi-value">€6.35B</div>
        <div class="kpi-sub">Allergan Pharma International — 49.7% of total</div>
      </div>
      <div class="kpi-card blue">
        <div class="kpi-label">Highest PBT</div>
        <div class="kpi-value">€7.94B</div>
        <div class="kpi-sub">Allergan Equities Unlimited</div>
      </div>
      <div class="kpi-card red">
        <div class="kpi-label">Largest Loss</div>
        <div class="kpi-value">−€1.48B</div>
        <div class="kpi-sub">AbbVie Manufacturing Mgmt</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="chart-card">
        <h3>Revenue Distribution</h3>
        <div class="chart-sub">Revenue share across reporting entities (€B)</div>
        <div class="chart-wrapper"><canvas id="chartRevDist"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Profit Before Tax — All Reporting Entities</h3>
        <div class="chart-sub">Sorted by PBT magnitude</div>
        <div class="chart-wrapper" style="height:520px"><canvas id="chartPBT"></canvas></div>
      </div>
    </div>

    <div class="chart-card grid-full">
      <h3>Revenue vs Profit Scatter</h3>
      <div class="chart-sub">Bubble size = Total Assets — reveals disproportionate structures</div>
      <div class="chart-wrapper" style="height:380px"><canvas id="chartScatter"></canvas></div>
    </div>
  </div>

  <!-- ═══════ TAX ANALYSIS ═══════ -->
  <div class="section" id="sec-tax">
    <h2 class="section-title">Tax Forensics</h2>
    <p class="section-desc">Effective tax rates, anomalies, and tax contribution analysis</p>

    <div class="kpi-strip">
      <div class="kpi-card red">
        <div class="kpi-label">Aggregate Net Tax</div>
        <div class="kpi-value">−€924K</div>
        <div class="kpi-sub">Net refund position across all entities</div>
      </div>
      <div class="kpi-card amber">
        <div class="kpi-label">Mean ETR (Reporting)</div>
        <div class="kpi-value">5.5%</div>
        <div class="kpi-sub">vs Ireland statutory 12.5%</div>
      </div>
      <div class="kpi-card purple">
        <div class="kpi-label">Entities with Negative ETR</div>
        <div class="kpi-value">3</div>
        <div class="kpi-sub">Tax refunds despite activity</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="chart-card">
        <h3>Effective Tax Rate Comparison</h3>
        <div class="chart-sub">ETR vs Ireland statutory rate (12.5%) — red line</div>
        <div class="chart-wrapper"><canvas id="chartETR"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Tax Paid vs PBT</h3>
        <div class="chart-sub">Entities with both tax and PBT data</div>
        <div class="chart-wrapper"><canvas id="chartTaxPBT"></canvas></div>
      </div>
    </div>

    <div class="chart-card grid-full">
      <h3>ETR Anomaly Waterfall</h3>
      <div class="chart-sub">Deviation from 12.5% statutory rate — positive = overpaying, negative = underpaying</div>
      <div class="chart-wrapper"><canvas id="chartETRWaterfall"></canvas></div>
    </div>
  </div>

  <!-- ═══════ ASSETS & IP ═══════ -->
  <div class="section" id="sec-assets">
    <h2 class="section-title">Assets & Intellectual Property</h2>
    <p class="section-desc">Asset concentration, intangible loading, and patent portfolio analysis</p>

    <div class="kpi-strip">
      <div class="kpi-card amber">
        <div class="kpi-label">Total Assets</div>
        <div class="kpi-value">€135.2B</div>
        <div class="kpi-sub">20 reporting entities</div>
      </div>
      <div class="kpi-card purple">
        <div class="kpi-label">Intangible Assets</div>
        <div class="kpi-value">€20.6B</div>
        <div class="kpi-sub">15.2% of total</div>
      </div>
      <div class="kpi-card cyan">
        <div class="kpi-label">Total Patents</div>
        <div class="kpi-value">8,967</div>
        <div class="kpi-sub">Across 16 entities</div>
      </div>
      <div class="kpi-card green">
        <div class="kpi-label">Top Asset Holder</div>
        <div class="kpi-value">€53.9B</div>
        <div class="kpi-sub">Allergan Ireland UC — 3 employees</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="chart-card">
        <h3>Asset Treemap</h3>
        <div class="chart-sub">Area proportional to total assets</div>
        <div class="treemap-container" id="assetTreemap"></div>
      </div>
      <div class="chart-card">
        <h3>Intangibles as % of Assets</h3>
        <div class="chart-sub">Intangible loading ratio — key IP shift indicator</div>
        <div class="chart-wrapper"><canvas id="chartIntangRatio"></canvas></div>
      </div>
    </div>

    <div class="grid-2">
      <div class="chart-card">
        <h3>Patent Distribution</h3>
        <div class="chart-sub">Patents held by entity</div>
        <div class="chart-wrapper"><canvas id="chartPatents"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Assets per Employee</h3>
        <div class="chart-sub">Reveals asset-heavy / employee-light structures</div>
        <div class="stat-bar-group" id="assetPerEmpBars"></div>
      </div>
    </div>
  </div>

  <!-- ═══════ RED FLAGS ═══════ -->
  <div class="section" id="sec-flags">
    <h2 class="section-title">Forensic Red Flags</h2>
    <p class="section-desc">Anomalies and structural features commonly scrutinised in tax forensics</p>

    <div class="flag-grid">
      <div class="flag-card critical">
        <div class="flag-badge">Critical</div>
        <div class="flag-title">Negative Aggregate Tax Position</div>
        <div class="flag-desc">Across 11 reporting entities, AbbVie's Irish structure shows a net tax refund of −€924K despite €8.53B in aggregate PBT. This is a highly unusual position warranting investigation.</div>
      </div>
      <div class="flag-card critical">
        <div class="flag-badge">Critical</div>
        <div class="flag-title">Extreme Asset/Employee Ratio</div>
        <div class="flag-desc">AbbVie International Holdings holds €27B in assets with only 3 employees — €9B per employee. Allergan Ireland UC holds €53.9B with no reported employees. Classic indicators of brass-plate entities.</div>
      </div>
      <div class="flag-card critical">
        <div class="flag-badge">Critical</div>
        <div class="flag-title">Massive PBT with Zero Tax</div>
        <div class="flag-desc">Allergan Equities UC reports €7.94B PBT with no tax reported. Allergan Ireland UC reports €518M PBT with no tax. AbbVie Ireland Holdings reports €15.3M PBT with no tax.</div>
      </div>
      <div class="flag-card warning">
        <div class="flag-badge">Warning</div>
        <div class="flag-title">Heavy Intangible Loading</div>
        <div class="flag-desc">AbbVie Manufacturing Mgmt holds €13.75B in intangibles (52.9% of its €26B assets). Allergan Pharma International holds €6.85B intangibles (77.5% of assets). Classic IP shifting pattern.</div>
      </div>
      <div class="flag-card warning">
        <div class="flag-badge">Warning</div>
        <div class="flag-title">Revenue Concentration with Losses</div>
        <div class="flag-desc">AbbVie Manufacturing Mgmt generates €5.99B revenue but reports a −€1.48B loss. Combined with high intangibles and only 82 employees, this suggests aggressive transfer pricing.</div>
      </div>
      <div class="flag-card warning">
        <div class="flag-badge">Warning</div>
        <div class="flag-title">11 Apparent Shell Entities</div>
        <div class="flag-desc">11 of 31 entities report no meaningful financial data — no revenue, no PBT, no assets, no employees. These may serve as holding or routing vehicles in the tax structure.</div>
      </div>
      <div class="flag-card info">
        <div class="flag-badge">Note</div>
        <div class="flag-title">Negative ETR Entities</div>
        <div class="flag-desc">Forest Labs Ireland (-20.1% ETR), Warner Chilcott Intermediate (-45.4%), and Allergan Services International (-4.5%) all show negative effective tax rates.</div>
      </div>
      <div class="flag-card info">
        <div class="flag-badge">Note</div>
        <div class="flag-title">4,460 Patents in Entity with No Revenue</div>
        <div class="flag-desc">Allergan Unlimited Company holds 4,460 patents — 49.7% of all patents — yet reports no revenue and a −€3M loss. IP may be centralized here for licensing arrangements.</div>
      </div>
    </div>
  </div>

  <!-- ═══════ ALL ENTITIES TABLE ═══════ -->
  <div class="section" id="sec-entities">
    <h2 class="section-title">Entity-Level Data</h2>
    <p class="section-desc">Full dataset — click column headers to sort, use search to filter</p>

    <div class="data-table-wrapper">
      <div class="table-header-bar">
        <h3>31 Irish Entities</h3>
        <input type="text" class="table-search" id="tableSearch" placeholder="Search entities...">
      </div>
      <div class="data-table-scroll">
        <table class="data-table" id="entityTable">
          <thead>
            <tr>
              <th data-col="name">Entity <span class="sort-arrow">↕</span></th>
              <th data-col="revenue">Revenue <span class="sort-arrow">↕</span></th>
              <th data-col="pbt">PBT <span class="sort-arrow">↕</span></th>
              <th data-col="tax">Tax <span class="sort-arrow">↕</span></th>
              <th data-col="etr">ETR % <span class="sort-arrow">↕</span></th>
              <th data-col="intangibles">Intangibles <span class="sort-arrow">↕</span></th>
              <th data-col="assets">Assets <span class="sort-arrow">↕</span></th>
              <th data-col="employees">Employees <span class="sort-arrow">↕</span></th>
              <th data-col="patents">Patents <span class="sort-arrow">↕</span></th>
            </tr>
          </thead>
          <tbody id="entityTableBody"></tbody>
        </table>
      </div>
    </div>
    <p class="footnote">Note: "." or blank values indicate data not reported. Negative PBT = loss; negative tax = refund. ETR = Effective Tax Rate (Tax / PBT × 100).</p>
  </div>

</div>

<script>
// ════════════════════════════════════════
//  DATA
// ════════════════════════════════════════
const entities = [
  { name:"Allergan Pharmaceuticals International Ltd", revenue:6345000000, pbt:1692000000, tax:177904840, etr:10.50, intangibles:6853000000, assets:8846000000, employees:119, patents:861 },
  { name:"AbbVie Manufacturing Mgmt UC", revenue:5992000000, pbt:-1480000000, tax:-183097833, etr:12.35, intangibles:13750000000, assets:26010000000, employees:82, patents:947 },
  { name:"Fournier Laboratories Ireland Ltd", revenue:200000000, pbt:6799598, tax:1257069, etr:18.49, intangibles:86229, assets:251900000, employees:213, patents:30 },
  { name:"Forest Laboratories Ireland Ltd", revenue:157800000, pbt:15745586, tax:-3168589, etr:-20.12, intangibles:0, assets:260000000, employees:272, patents:233 },
  { name:"AbbVie Limited", revenue:63568439, pbt:3155487, tax:713249, etr:22.60, intangibles:0, assets:47277071, employees:95, patents:169 },
  { name:"AbbVie International Holdings UC", revenue:2074152, pbt:-134000000, tax:4551276, etr:-3.40, intangibles:0, assets:27000000000, employees:3, patents:192 },
  { name:"Zeltiq Ireland UC", revenue:80500, pbt:725869, tax:190267, etr:26.21, intangibles:null, assets:25425588, employees:null, patents:null },
  { name:"Allergan Cayman Islands Foreign", revenue:null, pbt:null, tax:null, etr:null, intangibles:null, assets:null, employees:null, patents:null },
  { name:"Allergan Overseas Holding", revenue:null, pbt:6445131, tax:654167, etr:10.15, intangibles:0, assets:58794119, employees:null, patents:null },
  { name:"Pharmacyclics (Europe) Ltd", revenue:null, pbt:null, tax:null, etr:null, intangibles:null, assets:2.08, employees:null, patents:null },
  { name:"Allergan WC Ireland Holdings UC", revenue:null, pbt:1003669, tax:null, etr:null, intangibles:0, assets:24088097, employees:null, patents:57 },
  { name:"Warner Chilcott Holdings III Ltd", revenue:null, pbt:null, tax:null, etr:null, intangibles:null, assets:null, employees:null, patents:null },
  { name:"Warner Chilcott Holdings II Ltd", revenue:null, pbt:null, tax:null, etr:null, intangibles:null, assets:null, employees:null, patents:null },
  { name:"Allergan Services International UC", revenue:null, pbt:-22080, tax:1004, etr:-4.55, intangibles:null, assets:573095, employees:null, patents:null },
  { name:"Allergan Equities UC", revenue:null, pbt:7936000000, tax:null, etr:null, intangibles:null, assets:null, employees:null, patents:null },
  { name:"AbbVie Ireland NL B.V.", revenue:null, pbt:null, tax:null, etr:null, intangibles:null, assets:null, employees:null, patents:52 },
  { name:"Seabreeze Silicone UC", revenue:null, pbt:null, tax:null, etr:null, intangibles:null, assets:null, employees:null, patents:null },
  { name:"Warner Chilcott Intermediate (Ireland) UC", revenue:null, pbt:-11040, tax:5017, etr:-45.44, intangibles:null, assets:338236, employees:null, patents:17 },
  { name:"Immunogen Biopharma (Ireland) Ltd", revenue:null, pbt:null, tax:null, etr:null, intangibles:null, assets:1039, employees:null, patents:null },
  { name:"Allergan Ireland Holdings UC", revenue:null, pbt:null, tax:null, etr:null, intangibles:null, assets:106, employees:null, patents:null },
  { name:"Zeltiq Ireland Unltd Company", revenue:null, pbt:null, tax:null, etr:null, intangibles:null, assets:null, employees:null, patents:null },
  { name:"Zeltiq Ireland Intl Holdings UC", revenue:null, pbt:-129542, tax:null, etr:null, intangibles:12137, assets:20290309, employees:null, patents:null },
  { name:"Allergan Unlimited Company", revenue:null, pbt:-3011012, tax:null, etr:null, intangibles:0, assets:25091767, employees:null, patents:4460 },
  { name:"Allergan Holdings UC", revenue:null, pbt:236866, tax:65239, etr:27.54, intangibles:null, assets:5504130, employees:null, patents:38 },
  { name:"Warner Chilcott Limited", revenue:null, pbt:null, tax:null, etr:null, intangibles:null, assets:null, employees:null, patents:4 },
  { name:"Allergan Pharmaceuticals Ireland UC", revenue:null, pbt:null, tax:null, etr:null, intangibles:null, assets:null, employees:null, patents:1 },
  { name:"AbbVie Ireland Holdings UC", revenue:null, pbt:15307543, tax:null, etr:null, intangibles:0, assets:235100000, employees:null, patents:574 },
  { name:"Allergan Pharma Limited", revenue:null, pbt:null, tax:null, etr:null, intangibles:null, assets:null, employees:null, patents:1 },
  { name:"AbbVie Ireland UC", revenue:null, pbt:-44570005, tax:null, etr:null, intangibles:0, assets:18460000000, employees:null, patents:1331 },
  { name:"Allergan Dev Ventures I Ireland UC", revenue:null, pbt:null, tax:null, etr:null, intangibles:null, assets:null, employees:null, patents:null },
  { name:"Allergan Ireland UC", revenue:null, pbt:518600000, tax:null, etr:null, intangibles:0, assets:53930000000, employees:null, patents:null },
];

// ════════════════════════════════════════
//  HELPERS
// ════════════════════════════════════════
const fmt = (v, prefix='€') => {
  if (v === null || v === undefined) return '—';
  const abs = Math.abs(v);
  const sign = v < 0 ? '−' : '';
  if (abs >= 1e9) return sign + prefix + (abs/1e9).toFixed(2) + 'B';
  if (abs >= 1e6) return sign + prefix + (abs/1e6).toFixed(1) + 'M';
  if (abs >= 1e3) return sign + prefix + (abs/1e3).toFixed(0) + 'K';
  return sign + prefix + abs.toFixed(0);
};
const fmtNum = v => v === null ? '—' : v.toLocaleString();
const shortName = (n, max=28) => n.length > max ? n.slice(0, max-1) + '…' : n;

// Chart.js defaults
Chart.defaults.color = '#7c7fa8';
Chart.defaults.borderColor = 'rgba(30,32,53,0.8)';
Chart.defaults.font.family = "'Sora', sans-serif";
Chart.defaults.font.size = 11;
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.pointStyleWidth = 8;
Chart.defaults.plugins.legend.labels.padding = 16;

const chartColors = ['#0a84ff','#ff2d55','#ff9f0a','#30d158','#bf5af2','#64d2ff','#2dd4bf','#ff6482'];

// ════════════════════════════════════════
//  TAB NAVIGATION
// ════════════════════════════════════════
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('sec-' + tab.dataset.tab).classList.add('active');
  });
});

// ════════════════════════════════════════
//  OVERVIEW CHARTS
// ════════════════════════════════════════

// Revenue Concentration (horizontal bar) — top 4 only
const revEnts = entities.filter(e => e.revenue !== null).sort((a,b) => b.revenue - a.revenue);
const revTop4 = revEnts.slice(0, 4);
const revShortNames = {
  "Allergan Pharmaceuticals International Ltd": "Allergan Pharma Intl",
  "AbbVie Manufacturing Mgmt UC": "AbbVie Mfg Mgmt",
  "Fournier Laboratories Ireland Ltd": "Fournier Labs",
  "Forest Laboratories Ireland Ltd": "Forest Labs",
  "AbbVie Limited": "AbbVie Ltd",
  "AbbVie International Holdings UC": "AbbVie Intl Holdings",
  "Zeltiq Ireland UC": "Zeltiq Ireland",
};
new Chart(document.getElementById('chartRevenueConc'), {
  type: 'bar',
  data: {
    labels: revTop4.map(e => revShortNames[e.name] || shortName(e.name, 20)),
    datasets: [{
      data: revTop4.map(e => e.revenue / 1e9),
      backgroundColor: revTop4.map((_,i) => chartColors[i % chartColors.length] + '99'),
      borderColor: revTop4.map((_,i) => chartColors[i % chartColors.length]),
      borderWidth: 1,
      borderRadius: 4,
    }]
  },
  options: {
    indexAxis: 'y',
    responsive: true,
    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => { const v = ctx.raw * 1e9; return fmt(v); } } } },
    scales: {
      x: { title: { display: true, text: 'Revenue (€B)' }, grid: { color: 'rgba(255,255,255,0.03)' } },
      y: { grid: { display: false }, ticks: { font: { size: 12, weight: '500' }, padding: 8 } }
    }
  }
});

// Revenue per Employee
const revEmpEnts = entities.filter(e => e.revenue !== null && e.employees !== null);
new Chart(document.getElementById('chartRevPerEmp'), {
  type: 'bar',
  data: {
    labels: revEmpEnts.map(e => shortName(e.name, 24)),
    datasets: [{
      label: 'Revenue per Employee (€M)',
      data: revEmpEnts.map(e => (e.revenue / e.employees) / 1e6),
      backgroundColor: revEmpEnts.map(e => {
        const rpe = e.revenue / e.employees;
        if (rpe > 50e6) return '#ff2d5588';
        if (rpe > 10e6) return '#ff9f0a88';
        return '#30d15888';
      }),
      borderRadius: 4,
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => '€' + ctx.raw.toFixed(1) + 'M per employee' } } },
    scales: {
      y: { title: { display: true, text: '€M / Employee' }, grid: { color: 'rgba(255,255,255,0.03)' } },
      x: { grid: { display: false } }
    }
  }
});

// ════════════════════════════════════════
//  REVENUE & PROFIT CHARTS
// ════════════════════════════════════════

// Revenue Distribution (pie)
new Chart(document.getElementById('chartRevDist'), {
  type: 'pie',
  data: {
    labels: revEnts.map(e => shortName(e.name, 28)),
    datasets: [{
      data: revEnts.map(e => e.revenue / 1e9),
      backgroundColor: revEnts.map((_,i) => chartColors[i % chartColors.length] + 'aa'),
      borderColor: '#11121b',
      borderWidth: 2,
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { position: 'right', labels: { font: { size: 10 } } }, tooltip: { callbacks: { label: ctx => ctx.label + ': €' + ctx.raw.toFixed(2) + 'B' } } }
  }
});

// PBT bar chart
// PBT bar chart — all reporting entities
const pbtNames = {
  "Allergan Pharmaceuticals International Ltd": "Allergan Pharma Intl",
  "AbbVie Manufacturing Mgmt UC": "AbbVie Mfg Mgmt",
  "AbbVie International Holdings UC": "AbbVie Intl Holdings",
  "Fournier Laboratories Ireland Ltd": "Fournier Labs",
  "Forest Laboratories Ireland Ltd": "Forest Labs",
  "AbbVie Limited": "AbbVie Ltd",
  "Allergan Overseas Holding": "Allergan Overseas",
  "Allergan WC Ireland Holdings UC": "Allergan WC Ireland",
  "Allergan Services International UC": "Allergan Services Intl",
  "Warner Chilcott Intermediate (Ireland) UC": "Warner Chilcott Intm",
  "Allergan Holdings UC": "Allergan Holdings",
  "Zeltiq Ireland UC": "Zeltiq Ireland",
  "Zeltiq Ireland Intl Holdings UC": "Zeltiq Intl Holdings",
  "Allergan Unlimited Company": "Allergan UC",
  "Allergan Equities UC": "Allergan Equities",
  "AbbVie Ireland Holdings UC": "AbbVie Ireland Hldgs",
  "AbbVie Ireland UC": "AbbVie Ireland",
  "Allergan Ireland UC": "Allergan Ireland",
};
const pbtEnts = entities.filter(e => e.pbt !== null).sort((a,b) => b.pbt - a.pbt);
new Chart(document.getElementById('chartPBT'), {
  type: 'bar',
  data: {
    labels: pbtEnts.map(e => pbtNames[e.name] || shortName(e.name, 22)),
    datasets: [{
      data: pbtEnts.map(e => e.pbt / 1e6),
      backgroundColor: pbtEnts.map(e => e.pbt >= 0 ? '#30d15877' : '#ff2d5577'),
      borderColor: pbtEnts.map(e => e.pbt >= 0 ? '#30d158' : '#ff2d55'),
      borderWidth: 1,
      borderRadius: 3,
    }]
  },
  options: {
    indexAxis: 'y',
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => { const v = ctx.raw * 1e6; return fmt(v); } } } },
    scales: { x: { title: { display: true, text: 'PBT (€M)' }, grid: { color: 'rgba(255,255,255,0.03)' } }, y: { grid: { display: false }, ticks: { font: { size: 11, weight: '400' }, padding: 6 } } }
  }
});

// Scatter: Revenue vs PBT
const scatterNames = {
  "Allergan Pharmaceuticals International Ltd": "Allergan Pharma Intl",
  "AbbVie Manufacturing Mgmt UC": "AbbVie Mfg Mgmt",
  "AbbVie International Holdings UC": "AbbVie Intl Holdings",
  "Fournier Laboratories Ireland Ltd": "Fournier Labs",
  "Forest Laboratories Ireland Ltd": "Forest Labs",
  "AbbVie Limited": "AbbVie Ltd",
  "Zeltiq Ireland UC": "Zeltiq Ireland",
};
const scatterEnts = entities.filter(e => e.revenue !== null && e.pbt !== null && e.assets !== null);
new Chart(document.getElementById('chartScatter'), {
  type: 'bubble',
  data: {
    datasets: scatterEnts.map((e, i) => ({
      label: scatterNames[e.name] || shortName(e.name, 22),
      data: [{ x: e.revenue / 1e9, y: e.pbt / 1e9, r: Math.max(6, Math.sqrt(e.assets / 1e9) * 3) }],
      backgroundColor: chartColors[i % chartColors.length] + '77',
      borderColor: chartColors[i % chartColors.length],
      borderWidth: 1.5,
    }))
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'bottom', labels: { font: { size: 11, weight: '500' }, padding: 18 } },
      tooltip: { callbacks: {
        title: ctx => ctx[0].dataset.label,
        label: ctx => {
          const e = scatterEnts[ctx.datasetIndex];
          return ['Revenue: ' + fmt(e.revenue), 'PBT: ' + fmt(e.pbt), 'Assets: ' + fmt(e.assets)];
        }
      }}
    },
    scales: {
      x: { title: { display: true, text: 'Revenue (€B)' }, grid: { color: 'rgba(255,255,255,0.03)' } },
      y: { title: { display: true, text: 'PBT (€B)' }, grid: { color: 'rgba(255,255,255,0.03)' } }
    }
  }
});

// ════════════════════════════════════════
//  TAX ANALYSIS CHARTS
// ════════════════════════════════════════

// ETR comparison — flag false positive where both PBT & tax negative
const etrEnts = entities.filter(e => e.etr !== null).sort((a,b) => b.etr - a.etr);
const isFalsePositiveETR = (e) => e.pbt !== null && e.tax !== null && e.pbt < 0 && e.tax < 0 && e.etr > 0;
const etrShortNames = {
  "Allergan Pharmaceuticals International Ltd": "Allergan Pharma Intl",
  "AbbVie Manufacturing Mgmt UC": "AbbVie Mfg Mgmt ⚠️",
  "Fournier Laboratories Ireland Ltd": "Fournier Labs",
  "Forest Laboratories Ireland Ltd": "Forest Labs",
  "AbbVie Limited": "AbbVie Ltd",
  "AbbVie International Holdings UC": "AbbVie Intl Holdings",
  "Zeltiq Ireland UC": "Zeltiq Ireland",
  "Allergan Overseas Holding": "Allergan Overseas",
  "Allergan Services International UC": "Allergan Services Intl",
  "Warner Chilcott Intermediate (Ireland) UC": "Warner Chilcott Intm",
  "Allergan Holdings UC": "Allergan Holdings",
};
new Chart(document.getElementById('chartETR'), {
  type: 'bar',
  data: {
    labels: etrEnts.map(e => etrShortNames[e.name] || shortName(e.name, 22)),
    datasets: [{
      label: 'ETR %',
      data: etrEnts.map(e => e.etr),
      backgroundColor: etrEnts.map(e => {
        if (isFalsePositiveETR(e)) return '#bf5af244';
        if (e.etr < 0) return '#ff2d5577';
        if (e.etr < 12.5) return '#ff9f0a77';
        return '#30d15877';
      }),
      borderColor: etrEnts.map(e => {
        if (isFalsePositiveETR(e)) return '#bf5af2';
        if (e.etr < 0) return '#ff2d55';
        if (e.etr < 12.5) return '#ff9f0a';
        return '#30d158';
      }),
      borderWidth: etrEnts.map(e => isFalsePositiveETR(e) ? 2 : 1),
      borderRadius: 3,
      borderDash: etrEnts.map(e => isFalsePositiveETR(e) ? [4, 2] : []),
    }]
  },
  options: {
    indexAxis: 'y',
    responsive: true,
    plugins: {
      legend: { display: false },
      annotation: undefined,
      tooltip: { callbacks: { label: ctx => {
        const e = etrEnts[ctx.dataIndex];
        if (isFalsePositiveETR(e)) return ctx.raw.toFixed(2) + '% ⚠️ MISLEADING — both PBT & Tax negative (refund on loss)';
        return ctx.raw.toFixed(2) + '%';
      } } }
    },
    scales: {
      x: {
        title: { display: true, text: 'ETR %' },
        grid: { color: 'rgba(255,255,255,0.03)' },
      },
      y: { grid: { display: false }, ticks: { font: { size: 11, weight: '400' }, padding: 6 } }
    }
  },
  plugins: [{
    id: 'statutoryLine',
    afterDraw(chart) {
      const xScale = chart.scales.x;
      const x = xScale.getPixelForValue(12.5);
      const ctx = chart.ctx;
      ctx.save();
      ctx.beginPath();
      ctx.setLineDash([6, 4]);
      ctx.strokeStyle = '#ff2d55';
      ctx.lineWidth = 1.5;
      ctx.moveTo(x, chart.chartArea.top);
      ctx.lineTo(x, chart.chartArea.bottom);
      ctx.stroke();
      ctx.fillStyle = '#ff2d55';
      ctx.font = "10px 'Sora', sans-serif";
      ctx.fillText('12.5% Statutory', x + 6, chart.chartArea.top + 12);
      ctx.restore();
    }
  }, {
    id: 'falsePositiveLabel',
    afterDraw(chart) {
      const ctx = chart.ctx;
      const meta = chart.getDatasetMeta(0);
      etrEnts.forEach((e, i) => {
        if (isFalsePositiveETR(e)) {
          const bar = meta.data[i];
          ctx.save();
          ctx.fillStyle = '#bf5af2';
          ctx.font = "500 10px 'JetBrains Mono', monospace";
          ctx.textAlign = 'left';
          ctx.textBaseline = 'middle';
          ctx.fillText('FALSE POSITIVE — refund on loss', bar.x + 8, bar.y);
          ctx.restore();
        }
      });
    }
  }]
});

// Tax vs PBT — top 5 by PBT magnitude
const taxPbtNames = {
  "Allergan Pharmaceuticals International Ltd": "Allergan Pharma Intl",
  "AbbVie Manufacturing Mgmt UC": "AbbVie Mfg Mgmt",
  "AbbVie International Holdings UC": "AbbVie Intl Holdings",
  "Fournier Laboratories Ireland Ltd": "Fournier Labs",
  "Forest Laboratories Ireland Ltd": "Forest Labs",
  "AbbVie Limited": "AbbVie Ltd",
  "Allergan Overseas Holding": "Allergan Overseas",
  "Allergan Services International UC": "Allergan Services Intl",
  "Warner Chilcott Intermediate (Ireland) UC": "Warner Chilcott Intm",
  "Allergan Holdings UC": "Allergan Holdings",
  "Zeltiq Ireland UC": "Zeltiq Ireland",
};
const taxPbtEnts = entities.filter(e => e.tax !== null && e.pbt !== null).sort((a,b) => Math.abs(b.pbt) - Math.abs(a.pbt)).slice(0, 5);
new Chart(document.getElementById('chartTaxPBT'), {
  type: 'bar',
  data: {
    labels: taxPbtEnts.map(e => taxPbtNames[e.name] || shortName(e.name, 20)),
    datasets: [
      {
        label: 'PBT (€M)',
        data: taxPbtEnts.map(e => e.pbt / 1e6),
        backgroundColor: '#0a84ff55',
        borderColor: '#0a84ff',
        borderWidth: 1,
        borderRadius: 3,
      },
      {
        label: 'Tax (€M)',
        data: taxPbtEnts.map(e => e.tax / 1e6),
        backgroundColor: '#ff2d5555',
        borderColor: '#ff2d55',
        borderWidth: 1,
        borderRadius: 3,
      }
    ]
  },
  options: {
    responsive: true,
    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fmt(ctx.raw * 1e6) } } },
    scales: {
      y: { title: { display: true, text: '€M' }, grid: { color: 'rgba(255,255,255,0.03)' } },
      x: { grid: { display: false }, ticks: { font: { size: 11, weight: '500' }, padding: 6 } }
    }
  }
});

// ETR Waterfall (deviation from 12.5%) — flag false positives
const etrDevEnts = entities.filter(e => e.etr !== null).sort((a,b) => a.etr - b.etr);
new Chart(document.getElementById('chartETRWaterfall'), {
  type: 'bar',
  data: {
    labels: etrDevEnts.map(e => etrShortNames[e.name] || shortName(e.name, 22)),
    datasets: [{
      label: 'ETR Deviation from 12.5%',
      data: etrDevEnts.map(e => e.etr - 12.5),
      backgroundColor: etrDevEnts.map(e => {
        if (isFalsePositiveETR(e)) return '#bf5af244';
        return (e.etr - 12.5) < 0 ? '#ff2d5577' : '#30d15877';
      }),
      borderColor: etrDevEnts.map(e => {
        if (isFalsePositiveETR(e)) return '#bf5af2';
        return (e.etr - 12.5) < 0 ? '#ff2d55' : '#30d158';
      }),
      borderWidth: etrDevEnts.map(e => isFalsePositiveETR(e) ? 2 : 1),
      borderRadius: 3,
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => {
      const e = etrDevEnts[ctx.dataIndex];
      const prefix = (ctx.raw >= 0 ? '+' : '') + ctx.raw.toFixed(2) + 'pp';
      if (isFalsePositiveETR(e)) return prefix + ' ⚠️ FALSE POSITIVE — refund on loss';
      return prefix;
    } } } },
    scales: {
      y: { title: { display: true, text: 'Deviation (pp)' }, grid: { color: 'rgba(255,255,255,0.03)' } },
      x: { grid: { display: false }, ticks: { font: { size: 10 }, maxRotation: 45 } }
    }
  }
});

// ════════════════════════════════════════
//  ASSETS & IP
// ════════════════════════════════════════

// Treemap (custom CSS)
const assetEnts = entities.filter(e => e.assets !== null && e.assets > 1000).sort((a,b) => b.assets - a.assets);
const totalAssets = assetEnts.reduce((s,e) => s + e.assets, 0);
const treemapEl = document.getElementById('assetTreemap');
const tmColors = ['#0a84ff','#bf5af2','#ff2d55','#ff9f0a','#30d158','#64d2ff','#2dd4bf','#ff6482','#5e5ce6','#ac8e68'];

assetEnts.forEach((e, i) => {
  const pct = (e.assets / totalAssets) * 100;
  const div = document.createElement('div');
  div.className = 'treemap-item';
  const col = tmColors[i % tmColors.length];
  div.style.background = col + '18';
  div.style.border = '1px solid ' + col + '33';
  div.style.flexBasis = Math.max(pct * 2.5, 8) + '%';
  div.style.flexGrow = Math.max(1, Math.floor(pct / 5));
  div.innerHTML = `<span class="tm-name" style="color:${col}">${shortName(e.name, 30)}</span><span class="tm-value">${fmt(e.assets)}</span>`;

  div.addEventListener('mouseenter', (ev) => {
    const tip = document.getElementById('tooltip');
    tip.style.display = 'block';
    tip.innerHTML = `
      <div class="tt-title">${e.name}</div>
      <div class="tt-row"><span class="tt-label">Assets</span><span>${fmt(e.assets)}</span></div>
      <div class="tt-row"><span class="tt-label">Revenue</span><span>${fmt(e.revenue)}</span></div>
      <div class="tt-row"><span class="tt-label">PBT</span><span>${fmt(e.pbt)}</span></div>
      <div class="tt-row"><span class="tt-label">Employees</span><span>${fmtNum(e.employees)}</span></div>
      <div class="tt-row"><span class="tt-label">Intangibles</span><span>${fmt(e.intangibles)}</span></div>
    `;
  });
  div.addEventListener('mousemove', ev => {
    const tip = document.getElementById('tooltip');
    tip.style.left = (ev.clientX + 16) + 'px';
    tip.style.top = (ev.clientY - 10) + 'px';
  });
  div.addEventListener('mouseleave', () => {
    document.getElementById('tooltip').style.display = 'none';
  });
  treemapEl.appendChild(div);
});

// Intangibles ratio — top 4 with meaningful ratios
const intangEnts = entities.filter(e => e.intangibles !== null && e.intangibles > 0 && e.assets !== null && e.assets > 1000).sort((a,b) => (b.intangibles/b.assets) - (a.intangibles/a.assets)).slice(0, 4);
const intangNames = {
  "Allergan Pharmaceuticals International Ltd": "Allergan Pharma Intl",
  "AbbVie Manufacturing Mgmt UC": "AbbVie Mfg Mgmt",
  "Fournier Laboratories Ireland Ltd": "Fournier Labs",
  "Zeltiq Ireland Intl Holdings UC": "Zeltiq Intl Holdings",
};
new Chart(document.getElementById('chartIntangRatio'), {
  type: 'bar',
  data: {
    labels: intangEnts.map(e => intangNames[e.name] || shortName(e.name, 22)),
    datasets: [{
      label: 'Intangible %',
      data: intangEnts.map(e => (e.intangibles / e.assets) * 100),
      backgroundColor: intangEnts.map(e => {
        const r = e.intangibles / e.assets;
        if (r > 0.5) return '#ff2d5577';
        if (r > 0.2) return '#ff9f0a77';
        return '#0a84ff55';
      }),
      borderRadius: 3,
    }]
  },
  options: {
    indexAxis: 'y',
    responsive: true,
    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ctx.raw.toFixed(2) + '%' } } },
    scales: { x: { max: 100, title: { display: true, text: '% of Total Assets' }, grid: { color: 'rgba(255,255,255,0.03)' } }, y: { grid: { display: false }, ticks: { font: { size: 12, weight: '500' }, padding: 8 } } }
  },
  plugins: [{
    id: 'smallBarLabels',
    afterDraw(chart) {
      const ctx = chart.ctx;
      const meta = chart.getDatasetMeta(0);
      meta.data.forEach((bar, i) => {
        const val = chart.data.datasets[0].data[i];
        if (val < 5) {
          ctx.save();
          ctx.fillStyle = '#e2e4f0';
          ctx.font = "500 11px 'Sora', sans-serif";
          ctx.textAlign = 'left';
          ctx.textBaseline = 'middle';
          const x = bar.x + 8;
          const y = bar.y;
          ctx.fillText(val.toFixed(2) + '%', x, y);
          ctx.restore();
        }
      });
    }
  }]
});

// Patent distribution
const patEnts = entities.filter(e => e.patents !== null && e.patents > 0).sort((a,b) => b.patents - a.patents);
new Chart(document.getElementById('chartPatents'), {
  type: 'bar',
  data: {
    labels: patEnts.map(e => shortName(e.name, 22)),
    datasets: [{
      data: patEnts.map(e => e.patents),
      backgroundColor: '#bf5af255',
      borderColor: '#bf5af2',
      borderWidth: 1,
      borderRadius: 3,
    }]
  },
  options: {
    indexAxis: 'y',
    responsive: true,
    plugins: { legend: { display: false } },
    scales: { x: { title: { display: true, text: 'Patents' }, grid: { color: 'rgba(255,255,255,0.03)' } }, y: { grid: { display: false }, ticks: { font: { size: 9 } } } }
  }
});

// Assets per employee bars
const apeEnts = entities.filter(e => e.assets !== null && e.employees !== null).sort((a,b) => (b.assets/b.employees) - (a.assets/a.employees));
const maxApe = apeEnts[0] ? apeEnts[0].assets / apeEnts[0].employees : 1;
const barContainer = document.getElementById('assetPerEmpBars');
apeEnts.forEach(e => {
  const ape = e.assets / e.employees;
  const pct = (ape / maxApe) * 100;
  let color = '#30d158';
  if (ape > 1e9) color = '#ff2d55';
  else if (ape > 100e6) color = '#ff9f0a';
  const item = document.createElement('div');
  item.className = 'stat-bar-item';
  item.innerHTML = `
    <div class="stat-bar-label">
      <span class="sbl-name">${shortName(e.name, 30)}</span>
      <span class="sbl-value">${fmt(ape)}/emp</span>
    </div>
    <div class="stat-bar-track">
      <div class="stat-bar-fill" style="width:${pct}%;background:${color}"></div>
    </div>
  `;
  barContainer.appendChild(item);
});

// ════════════════════════════════════════
//  ENTITY TABLE
// ════════════════════════════════════════
let sortCol = null;
let sortDir = 1;

function renderTable(filter = '') {
  const tbody = document.getElementById('entityTableBody');
  let data = [...entities];
  if (filter) {
    const f = filter.toLowerCase();
    data = data.filter(e => e.name.toLowerCase().includes(f));
  }
  if (sortCol) {
    data.sort((a, b) => {
      let va = a[sortCol], vb = b[sortCol];
      if (sortCol === 'name') return sortDir * va.localeCompare(vb);
      if (va === null) return 1;
      if (vb === null) return -1;
      return sortDir * (va - vb);
    });
  }

  tbody.innerHTML = data.map(e => {
    const cell = (v, isCur=true) => {
      if (v === null || v === undefined) return '<td class="num na">—</td>';
      const cls = v < 0 ? 'num negative' : 'num positive';
      return `<td class="${cls}">${isCur ? fmt(v) : (typeof v === 'number' ? v.toLocaleString() : v)}</td>`;
    };
    return `<tr>
      <td title="${e.name}">${e.name}</td>
      ${cell(e.revenue)}
      ${cell(e.pbt)}
      ${cell(e.tax)}
      <td class="num ${e.etr !== null ? (e.etr < 0 ? 'negative' : (e.pbt < 0 && e.tax < 0 && e.etr > 0 ? 'negative' : '')) : 'na'}" title="${e.pbt < 0 && e.tax < 0 && e.etr > 0 ? 'False positive: both PBT & Tax negative' : ''}">${e.etr !== null ? e.etr.toFixed(2) + '%' + (e.pbt < 0 && e.tax < 0 && e.etr > 0 ? ' ⚠️' : '') : '—'}</td>
      ${cell(e.intangibles)}
      ${cell(e.assets)}
      <td class="num ${e.employees !== null ? '' : 'na'}">${e.employees !== null ? e.employees : '—'}</td>
      <td class="num ${e.patents !== null ? '' : 'na'}">${e.patents !== null ? e.patents.toLocaleString() : '—'}</td>
    </tr>`;
  }).join('');
}

// Sort
document.querySelectorAll('#entityTable thead th').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.col;
    if (sortCol === col) sortDir *= -1;
    else { sortCol = col; sortDir = -1; }
    document.querySelectorAll('#entityTable thead th').forEach(t => t.classList.remove('sorted'));
    th.classList.add('sorted');
    renderTable(document.getElementById('tableSearch').value);
  });
});

// Search
document.getElementById('tableSearch').addEventListener('input', e => {
  renderTable(e.target.value);
});

renderTable();

// ════════════════════════════════════════
//  ANIMATE STAT BARS ON LOAD
// ════════════════════════════════════════
setTimeout(() => {
  document.querySelectorAll('.stat-bar-fill').forEach(bar => {
    const w = bar.style.width;
    bar.style.width = '0%';
    requestAnimationFrame(() => { bar.style.width = w; });
  });
}, 100);
</script>
</body>
</html>
